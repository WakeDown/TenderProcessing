@using System.Web.Script.Serialization
@using DocumentFormat.OpenXml.Wordprocessing
@using TenderProcessingDataAccessLayer.Models

@{
    ViewBag.Title = "Расчет заявки";
    Layout = "~/Views/Shared/_MasterPage.cshtml";
    var serializer = new JavaScriptSerializer();
    var claim = (TenderClaim)ViewBag.Claim;
}
<style type="text/css">
    .claimInfoLabel {
        font-weight: bold;
        color: blue;
    }

    .claimInfoValueLabel {
        font-weight: bold;
    }

    .cell {
        border: 1px solid gray;
    }
</style>
<script type="text/javascript">
    var claim = @Html.Raw(serializer.Serialize(claim));
    var status = "@ViewBag.Status";
    var dealType = "@ViewBag.DealType";

    $(init);

    function init() {
        messageUi.initProgressImage();
        window.addEventListener("message", messageHandler, true);
        $("#butGetExcelFile").click(getExcelFileFromServer);
        $("#butUploadExcelFile").click(openFile);
        if (claim == null) {
            messageUi.show("Заявка не найдена<br/>или у Вас нет доступа к ней");
        } else {
            showClaimInfo(claim);
            initPositions(claim.Positions);
            $("#butSendOnConfirm").click(sendOnConfirm);
            var noAction = true;
            var positionsLength = claim.Positions.length;
            for (var i = 0; i < positionsLength; i++) {
                var position = claim.Positions[i];
                if (position.State == 1 || position.state == 3) {
                    noAction = false;
                    break;
                }
            }
            if (noAction) {
                setPositionsToNoAction();
                $("#butSendOnConfirm").hide();
                $("#butGetExcelFile").hide();
                $("#butUploadExcelFile").hide();
            }
        }
    }

    function openFile() {
        var obj = {
            type: "mainWindow",
            error: false,
            message: "openFile"
        }
        var message = JSON.stringify(obj);
        sendMessage(message);
    }

    function sendMessage(message) {
        var target = getTargetOrigin();
        document.getElementById("uploadFile").contentWindow.postMessage(message, target);
    }

    function getTargetOrigin() {
        var url = document.location.href;
        url = url.replace("http://", "");
        var index = url.indexOf("/");
        url = url.substr(0, index);
        url = "http://" + url;
        return url;
    }

    function messageHandler(e) {
        var data = e.data;
        var obj = $.parseJSON(data);
        if (obj.type.trim() == "UploadFrameLoaded") {
            $("#butUploadExcelFile").show();
        }
        if (obj.type.trim() == "DownloadExcel") {
            if (obj.error == true) {
                messageUi.show("Ошибка при скачивании файла!", true, null, 1750);
            }
        }
        if (obj.type.trim() == "UploadExcel") {
            if (obj.error == true) {
                messageUi.show(obj.message);
            }
        }
        if (obj.type.trim() == "UploadExcelResult") {
            if (obj.error == true) {
                messageUi.show(obj.message);
            } else {
                $("#positionsTable").empty();
                var positions = obj.message;
                var positionLength = claim.Positions.length;
                for (var i = 0; i < positionLength; i++) {
                    var position = claim.Positions[i];
                    position.Calculations = [];
                    var serverPosition = getPosition(positions, position.Id);
                    if (serverPosition != null) {
                        position.Calculations = serverPosition.Calculations;
                    }
                }
                initPositions(claim.Positions);
            }
        }
    }

    function getPosition(arr, id) {
        var position = null;
        var arrLength = arr.length;
        for (var i = 0; i < arrLength; i++) {
            var model = arr[i];
            if (model.Id == id) {
                position = model;
                break;
            }
        }
        return position;
    }

    function getExcelFileFromServer() {
        $("body").append("<iframe src='/CalculationSpecification/GetSpecificationFile?claimId=" + claim.Id + "' width='0' height='0' style='display: none;' align='left'></iframe>");
    }

    function sendOnConfirm() {
        $.ajax({
            url: "/CalculationSpecification/SetPositionToConfirm?idClaim=" + claim.Id,
            type: 'GET',
            contentType: 'application/json; charset = utf-8 ',
            success: function(data) {
                if (data.IsComplete) {
                    $("#butSendOnConfirm").hide();
                    $("#butGetExcelFile").hide();
                    $("#butUploadExcelFile").hide();
                    setPositionsToNoAction();
                } else {
                    messageUi.show(data.Message, true, null, 1700);
                }
            }
        });
    }

    function setPositionsToNoAction() {
        var table = $("#positionsTable");
        var addCalcButtons = $("[modetype='addCalcButton']", table);
        addCalcButtons.hide();
        var calcRows = $("[type='positionCalculate']", table);
        $.each(calcRows, function(index, elem) {
            if (elem.hasAttribute("calcId")) {
                setCalculatePositionReadOnly($(elem));
                $("[type='actionPanel']", $(elem)).remove();
            } else {
                $(elem).remove();
            }
        });
    }

    function initPositions(positions) {
        if (positions == null) return;
        var container = $("#positionsTable");
        var positionsLength = positions.length;
        for (var i = 0; i < positionsLength; i++) {
            var position = positions[i];
            var element = getPositionElement(position);
            container.append(element);
            var lastElement = element;
            if (position.Calculations != null) {
                var calculationsLength = position.Calculations.length;
                for (var j = 0; j < calculationsLength; j++) {
                    var calculation = position.Calculations[j];
                    var calcRow = getCalculatePositionElement();
                    calcRow.attr("calcPositionId", position.Id);
                    calcRow.attr("calcId", calculation.Id);
                    var saveCalculationButton = $("[modetype='saveCalcButton']", calcRow);
                    saveCalculationButton.click(saveCalculate);
                    var cancelCalculationButton = $("[modetype='cancelCalcButton']", calcRow);
                    cancelCalculationButton.click(cancelCalculate);
                    var deleteCalculationButton = $("[modetype='deleteCalcButton']", calcRow);
                    deleteCalculationButton.click(deleteCalculate);
                    var editCalculationButton = $("[modetype='editCalcButton']", calcRow);
                    editCalculationButton.click(editCalculateButtonClick);
                    var editCalculationButtonOk = $("[modetype='editCalcButtonOk']", calcRow);
                    editCalculationButtonOk.click(editCalculate);
                    var editCalculationButtonCancel = $("[modetype='editCalcButtonCancel']", calcRow);
                    editCalculationButtonCancel.click(editCalculateCancel);
                    deleteCalculationButton.hide();
                    lastElement.after(calcRow);
                    lastElement = calcRow;
                    calcRow.show();
                    $("[modetype='saveCalcButton']", calcRow).show();
                    $("[modetype='cancelCalcButton']", calcRow).show();
                    $("[modetype='calculateCatalogNumber']", calcRow).val(calculation.CatalogNumber);
                    $("[modetype='calculateName']", calcRow).val(calculation.Name);
                    $("[modetype='calculateReplace']", calcRow).val(calculation.Replace);
                    $("[modetype='calculatePriceUsd']", calcRow).val(calculation.PriceUsd != 0 ? calculation.PriceUsd : "");
                    $("[modetype='calculateSumUsd']", calcRow).val(calculation.SumUsd ? calculation.SumUsd : "");
                    $("[modetype='calculatePriceRub']", calcRow).val(calculation.PriceRub ? calculation.PriceRub : "");
                    $("[modetype='calculateSumRub']", calcRow).val(calculation.SumRub);
                    $("[modetype='calculateProvider']", calcRow).val(calculation.Provider);
                    $("[modetype='calculateProtectCondition']", calcRow).val(calculation.ProtectCondition);
                    $("[modetype='calculateComment']", calcRow).val(calculation.Comment);
                    var providerFact = $("[modetype='calculateProtectFact']", calcRow);
                    $("[value='" + calculation.ProtectFact + "']", providerFact).attr("selected", "selected");
                    $("[modetype='saveCalcButton']", calcRow).hide();
                    $("[modetype='cancelCalcButton']", calcRow).hide();
                    $("[type='editPositionPanel']", calcRow).show();
                    $("[modetype='deleteCalcButton']", calcRow).show();
                    setCalculatePositionReadOnly(calcRow);
                }
            }
        }
    }

    function showClaimInfo(model) {
        $("#claimId").text(model.Id);
        $("#claimCustomer").text("Заказчик: " + model.Customer + " ИНН: " + model.CustomerInn);
        $("#claimTenderStart").text(model.TenderStartString);
        $("#claimDeadline").text(model.ClaimDeadlineString);
        $("#kPDeadline").text(model.KPDeadlineString);
        $("#claimManager").text(model.Manager.Name);
        $("#managerSubDivision").text(model.Manager.SubDivision);
        $("#managerChief").text(model.Manager.Chief);
        $("#claimDealType").text(dealType);
        var sum = "";
        if (model.Sum > 0) {
            sum = model.Sum.toFixed(2);
        }
        $("#claimSum").text(sum);
        $("#claimTenderNumber").text(model.TenderNumber);
        $("#claimTenderStatus").text(status);
        if (model.TenderUrl != "") {
            var link = $("<a href='" + model.TenderUrl + "' target='blank'>[ссылка]</a>");
            $("#claimTenderUrl").append(link);   
        }
    }

    function getPositionElement(position) {
        var element = $("#positionElementTemplate").clone();
        element.removeAttr("id");
        element.show();
        element.attr("positionId", position.Id);
        $("[type='catalogNumberLabel']", element).text(position.CatalogNumber);
        $("[type='nameLabel']", element).text(position.Name);
        $("[type='replaceLabel']", element).text(position.Replace);
        $("[type='unitLabel']", element).text(getUnitString(position.Unit));
        $("[type='valueLabel']", element).text(position.Value);
        $("[type='commentLabel']", element).text(position.Comment);
        var price = "";
        if (position.Price != 0) price = position.Price.toFixed(2);
        $("[type='priceLabel']", element).text(price);
        var sum = "";
        if (position.Sum != 0) sum = position.Sum.toFixed(2);
        $("[type='sumLabel']", element).text(sum);
        var addCalculateButton = $("[modetype='addCalcButton']", element);
        addCalculateButton.click(addCalculateButtonClick);
        return element;
    }

    function deleteCalculate(e) {
        var button = $(e.currentTarget);
        var row = button.closest("[type='positionCalculate']");
        var calculateId = row.attr("calcId");
        var initalBackGround = row.css("background-color");
        row.css("backgroundColor", "#EAA4A4");
        var deleted = confirm("Вы уверены что хотите удалить выделенную запись?");
        row.css("backgroundColor", initalBackGround);
        if (deleted) {
            $.ajax({
                url: "/CalculationSpecification/Delete?id=" + calculateId,
                type: 'GET',
                contentType: 'application/json; charset = utf-8 ',
                success: function(data) {
                    if (data.IsComplete) {
                        row.remove();
                    } else {
                        messageUi.show("Запись не удалена", true, null, 1700);
                    }
                }
            });
        }
    }

    function editCalculateButtonClick(e) {
        var button = $(e.currentTarget);
        var row = button.parent().parent().parent().parent().parent().parent();
        button.hide();
        $("[modetype='deleteCalcButton']", row).hide();
        $("[type='editPositionActionPanel']", row).show();
        $("table", row).css("backgroundColor", "rgb(200, 230, 255)");
        var controlTypeNames = ["calculateCatalogNumber", "calculateName", "calculateReplace", "calculatePriceUsd", "calculateSumUsd", "calculatePriceRub", "calculateSumRub", "calculateProvider", "calculateProtectCondition", "calculateComment"];
        var controlTypeNamesLength = controlTypeNames.length;
        for (var i = 0; i < controlTypeNamesLength; i++) {
            var controlTypeName = controlTypeNames[i];
            var control = $("[modetype='" + controlTypeName + "']", row);
            var label = $("[modetype='" + controlTypeName + "ValueLabel']", row);
            var value = label.text().trim();
            control.val(value);
        }
        var providerFact = $("[modetype='calculateProtectFact']", row);
        var providerFactValue = $("[modetype='calculateProtectFactValueLabel']", row).text();
        $("[value='" + providerFactValue + "']", providerFact).attr("selected", "selected");
        $("[ type='readOnlyModeView']", row).hide();
        $("[ type='editModeView']", row).show();

    }

    function editCalculate(e) {
        var button = $(e.currentTarget);
        var row = button.closest("[type='positionCalculate']");
        var obj = getCalculatePositionModelForPosition(row);
        if (!obj.isValid) {
            messageUi.show(obj.message);
        } else {
            var model = obj.model;
            model.Id = Number(row.attr("calcId"));
            $.ajax({
                url: "/CalculationSpecification/Edit",
                type: 'POST',
                dataType: 'json',
                data: JSON.stringify(model),
                processData: false,
                contentType: 'application/json; charset = utf-8 ',
                success: function(data) {
                    if (data.IsComplete) {
                        $("[modetype='deleteCalcButton']", row).show();
                        $("[type='editPositionActionPanel']", row).hide();
                        $("[modetype='editCalcButton']", row).show();
                        setCalculatePositionReadOnly(row);
                    } else {
                        messageUi.show("Ошибка при изменении расчета", true, null, 1700);
                    }
                }
            });
        }
    }

    function editCalculateCancel(e) {
        var button = $(e.currentTarget);
        var row = button.closest("[type='positionCalculate']");
        $("[modetype='deleteCalcButton']", row).show();
        $("[type='editPositionActionPanel']", row).hide();
        $("[modetype='editCalcButton']", row).show();
        $("table", row).css("backgroundColor", "rgb(230, 230, 255)");
        $("[ type='readOnlyModeView']", row).show();
        $("[ type='editModeView']", row).hide();
    }

    function addCalculateButtonClick(e) {
        var button = $(e.currentTarget);
        var row = button.parent().parent();
        var calcRow = getCalculatePositionElement();
        calcRow.attr("calcPositionId", row.attr("positionId"));
        var saveCalculationButton = $("[modetype='saveCalcButton']", calcRow);
        saveCalculationButton.click(saveCalculate);
        var cancelCalculationButton = $("[modetype='cancelCalcButton']", calcRow);
        cancelCalculationButton.click(cancelCalculate);
        var deleteCalculationButton = $("[modetype='deleteCalcButton']", calcRow);
        deleteCalculationButton.click(deleteCalculate);
        var editCalculationButton = $("[modetype='editCalcButton']", calcRow);
        editCalculationButton.click(editCalculateButtonClick);
        var editCalculationButtonOk = $("[modetype='editCalcButtonOk']", calcRow);
        editCalculationButtonOk.click(editCalculate);
        var editCalculationButtonCancel = $("[modetype='editCalcButtonCancel']", calcRow);
        editCalculationButtonCancel.click(editCalculateCancel);
        deleteCalculationButton.hide();
        $("[type='editPositionPanel']", row).hide();
        row.after(calcRow);
        calcRow.show();
        $("[modetype='saveCalcButton']", calcRow).show();
        $("[modetype='cancelCalcButton']", calcRow).show();
    }

    function saveCalculate(e) {
        var button = $(e.currentTarget);
        var row = button.closest("[type='positionCalculate']");
        var obj = getCalculatePositionModelForPosition(row);
        if (!obj.isValid) {
            messageUi.show(obj.message);
        } else {
            var model = obj.model;
            model.IdSpecificationPosition = Number(row.attr("calcPositionId"));
            model.IdTenderClaim = claim.Id;
            $.ajax({
                url: "/CalculationSpecification/Save",
                type: 'POST',
                dataType: 'json',
                data: JSON.stringify(model),
                processData: false,
                contentType: 'application/json; charset = utf-8 ',
                success: function(data) {
                    if (data.IsComplete) {
                        row.attr("calcId", data.Id);
                        button.hide();
                        $("[modetype='saveCalcButton']", row).hide();
                        $("[modetype='cancelCalcButton']", row).hide();
                        $("[type='editPositionPanel']", row).show();
                        $("[modetype='deleteCalcButton']", row).show();
                        setCalculatePositionReadOnly(row);
                    } else {
                        messageUi.show("Ошибка при добавлении расчета", true, null, 1700);
                    }
                }
            });
        }
    }

    function setCalculatePositionReadOnly(row) {
        var controlTypeNames = ["calculateCatalogNumber", "calculateName", "calculateReplace", "calculatePriceUsd", "calculateSumUsd", "calculatePriceRub", "calculateSumRub", "calculateProvider", "calculateProtectCondition", "calculateComment"];
        var controlTypeNamesLength = controlTypeNames.length;
        for (var i = 0; i < controlTypeNamesLength; i++) {
            var controlTypeName = controlTypeNames[i];
            var control = $("[modetype='" + controlTypeName + "']", row);
            var value = control.val().trim();
            var label = $("[modetype='" + controlTypeName + "ValueLabel']", row);
            label.text(value);
        }
        var providerFact = $("[modetype='calculateProtectFact']", row);
        var providerFactValue = $(":selected", providerFact).val();
        $("[modetype='calculateProtectFactValueLabel']", row).text(providerFactValue);
        $("table", row).css("backgroundColor", "rgb(230, 230, 255)");
        $("[ type='readOnlyModeView']", row).show();
        $("[ type='editModeView']", row).hide();
    }

    function getCalculatePositionModelForPosition(row) {
        var obj = { isValid: true, message: "", model: null };
        var message = "";
        var calcRow = row;
        var catalogNumber = $("[modetype='calculateCatalogNumber']", calcRow).val().trim();
        if (catalogNumber == "") {
            obj.isValid = false;
            obj.message = "Заполните обязательное поле Каталожный номер";
        }
        var name = $("[modetype='calculateName']", calcRow).val().trim();
        if (name == "") {
            message = "Заполните обязательное поле Наименование";
            if (obj.message.trim() != "") {
                message = "<br/>" + message;
            }
            obj.isValid = false;
            obj.message += message;
        }
        var priceUsd = $("[modetype='calculatePriceUsd']", calcRow).val().trim();
        if (priceUsd != "") {
            if (isNaN(priceUsd)) {
                message = "Значение '" + priceUsd + "' в поле Цена за ед. USD не является числом";
                if (obj.message.trim() != "") {
                    message = "<br/>" + message;
                }
                obj.isValid = false;
                obj.message += message;
            }
        }
        var sumUsd = $("[modetype='calculateSumUsd']", calcRow).val().trim();
        if (sumUsd != "") {
            if (isNaN(sumUsd)) {
                message = "Значение '" + sumUsd + "' в поле Сумма вход USD не является числом";
                if (obj.message.trim() != "") {
                    message = "<br/>" + message;
                }
                obj.isValid = false;
                obj.message += message;
            }
        }
        var priceRub = $("[modetype='calculatePriceRub']", calcRow).val().trim();
        if (priceRub != "") {
            if (isNaN(priceRub)) {
                message = "Значение '" + priceRub + "' в поле Цена за ед. руб не является числом";
                if (obj.message.trim() != "") {
                    message = "<br/>" + message;
                }
                obj.isValid = false;
                obj.message += message;
            }
        }
        var sumRub = $("[modetype='calculateSumRub']", calcRow).val().trim();
        if (sumRub != "") {
            if (isNaN(sumRub)) {
                message = "Значение '" + sumRub + "' в поле Сумма вход руб не является числом";
                if (obj.message.trim() != "") {
                    message = "<br/>" + message;
                }
                obj.isValid = false;
                obj.message += message;
            }
        } else {
            message = "Заполните обязательное поле Сумма вход руб";
            if (obj.message.trim() != "") {
                message = "<br/>" + message;
            }
            obj.isValid = false;
            obj.message += message;
        }
        var protectCondition = $("[modetype='calculateProtectCondition']", calcRow).val().trim();
        var protectFact = $(":selected", $("[modetype='calculateProtectFact']", calcRow)).val().trim();
        if (protectFact == "null") {
            message = "Выберите значение Факт получения защиты";
            if (obj.message.trim() != "") {
                message = "<br/>" + message;
            }
            obj.isValid = false;
            obj.message += message;
        } else {
            if (protectCondition == "" && protectFact != "Не предоставляется") {
                message = "Заполните поле Условия защиты";
                if (obj.message.trim() != "") {
                    message = "<br/>" + message;
                }
                obj.isValid = false;
                obj.message += message;
            }    
        }
        if (obj.isValid) {
            var model = {
                CatalogNumber: catalogNumber,
                Name: name,
                SumRub: Number(sumRub),
                ProtectFact: protectFact,
                ProtectCondition: protectCondition,
                Comment: $("[modetype='calculateComment']", calcRow).val().trim(),
                Provider: $("[modetype='calculateProvider']", calcRow).val().trim(),
                Replace: $("[modetype='calculateReplace']", calcRow).val().trim()
            };
            if (priceUsd != "") {
                model.PriceUsd = Number(priceUsd);
            }
            if (sumUsd != "") {
                model.SumUsd = Number(sumUsd);
            }
            if (priceRub != "") {
                model.PriceRub = Number(priceRub);
            }
            obj.model = model;
        }
        return obj;
    }

    function cancelCalculate(e) {
        var button = $(e.currentTarget);
        var row = button.closest("[type='positionCalculate']");
        row.remove();
    }

    function getCalculatePositionElement() {
        var row = $("<tr></tr>");
        var cell = $("<td colspan='2'></td>");
        row.append(cell);
        var calcTable = $("#calculatePositionTable").clone();
        calcTable.show();
        calcTable.removeAttr("id");
        cell.append(calcTable);
        row.attr("type", "positionCalculate");
        return row;
    }

    function getUnitString(unit) {
        var result = "";
        switch (unit) {
            case 1:
                result = "Шт";
                break;
            case 2:
                result = "Упак";
                break;
        }
        return result;
    }
</script>
<div>
    <div class="panel panel-default">
        <div class="panel-heading">
            <h4>
                Заявка №<span id="claimId"></span>
                <div id="claimCustomer"></div>
            </h4>
        </div>
        <div class="panel-body">
            <div class="row">
                <div class="col-sm-2">
                    <div class="text-right">Дата начала:</div>
                    <div class="text-right">Срок сдачи:</div>
                    <div class="text-right">Срок подачи КП:</div>
                    <div class="text-right">Менеджер:</div>
                </div>
                <div class="col-sm-2">
                    <div>
                        <strong id="claimTenderStart"></strong>
                    </div>
                    <div>
                        <strong id="claimDeadline"></strong>
                    </div>
                    <div>
                        <strong id="kPDeadline"></strong>
                    </div>
                    <div>
                        <strong id="claimManager"></strong>
                    </div>
                    <div>
                        <small id="managerSubDivision"></small>
                    </div>
                    <div>
                        <small id="managerChief"></small>
                    </div>
                </div>
                <div class="col-sm-2">
                    <div class="text-right">Тип сделки:</div>
                    <div class="text-right">Сумма (с НДС):</div>
                </div>
                <div class="col-sm-2">
                    <div>
                        <strong id="claimDealType"></strong>
                    </div>
                    <div>
                        <strong id="claimSum"></strong>
                    </div>
                </div>
                <div class="col-sm-2">
                    <div class="text-right">№ конкурса:</div>
                    <div class="text-right">Статус конкурса:</div>
                    <div class="text-right">Ссылка на закупки:</div>
                </div>
                <div class="col-sm-2">
                    <div>
                        <strong id="claimTenderNumber"></strong>
                    </div>
                    <div>
                        <strong id="claimTenderStatus"></strong>
                    </div>
                    <div>
                        <small id="claimTenderUrl"></small>
                    </div>
                </div>
            </div>
            <div>
                <span id="excelPanel">
                    <button id="butGetExcelFile" type='button' class='btn btn-default'><i class="fa fa-download"></i> выгрузить спецификацию</button>
                    <button id="butUploadExcelFile" type='button' class='btn btn-default' style='margin: 4px; display: none;'><i class="fa fa-upload"></i> загрузить расчет спецификации</button>
                    <iframe id="uploadFile" src="/CalculationSpecification/UploadFileForm?claimId=@claim.Id" style="display: none;"></iframe>
                </span>
                <button type='button' id="butSendOnConfirm" class='btn btn-success'><i class="fa fa-bullhorn"></i> на подтверждение</button>
            </div>
        </div>
    </div>
    <div>
        <h5>Список позиций</h5>
        <h5>
            <span class="label label-default">Всего:<span>5</span></span>&nbsp;
            <span class="label label-info">из них рассчитано:<span>3</span></span>
        </h5>
        <table class="table table-striped small">
            <tbody id="positionsTable"></tbody>
        </table>
    </div>
    <table>
        <tr id="positionElementTemplate" style="display: none;">
            <td class="min-width">
                <button type="button" modetype='addCalcButton' class="btn btn-primary btn-lg" data-toggle="tooltip" title="добавить расчет"><i class="fa fa-plus"></i> <i class="fa fa-calculator"></i></button>
            </td>
            <td>
                <div class="col-sm-3">
                    <div>
                        <strong>[Каталожный номер]</strong>&nbsp;<span type='catalogNumberLabel'></span>
                    </div>
                    <div>
                        <strong>[Количество]</strong>&nbsp;<span type='valueLabel'></span>&nbsp;<span type='unitLabel'></span>
                    </div>
                    <div>
                        <strong>[Цена]</strong>&nbsp;<span type='priceLabel'></span>&nbsp; руб. за ед. макс.
                    </div>
                    <div>
                        <strong>[Сумма]</strong>&nbsp;<span type='sumLabel'></span>&nbsp;руб. всего макс.
                    </div>
                </div>
                <div class="col-sm-5">
                    <div>
                        <strong>Наименование</strong>
                        <div type='nameLabel'></div>
                    </div>
                    <div>
                        <strong>Замена</strong>
                        <div type='replaceLabel'></div>
                    </div>
                </div>
                <div class="col-sm-4">
                    <div class="form-group">
                        <label>Комментарий</label>
                        <div type="commentLabel"></div>
                    </div>
                </div>
            </td>
        </tr>
    </table>
    <table id="calculatePositionTable" style="width: 100%; display: none;">
        <tr>
            <td>
                <button type='button' modetype='saveCalcButton' class='btn btn-primary btn-lg' data-toggle='tooltip' title='сохранить'><i class='fa fa-save'></i></button><br />
                <button type='button' modetype='cancelCalcButton' class='btn btn-default btn-lg' data-toggle='tooltip' title='отмена'><i class='fa fa-undo'></i></button>
                <div type="editPositionPanel" style="display: none;">
                    <button type='button' modetype='editCalcButton' class='btn btn-link btn-lg' data-toggle='tooltip' title='изменить'><i class='fa fa-edit'></i></button>
                    <div type="editPositionActionPanel" style="display: none;">
                        <button type='button' modetype='editCalcButtonOk' class='btn btn-primary btn-lg' data-toggle='tooltip' title='изменить'><i class='fa fa-save'></i></button><br />
                        <button type='button' modetype='editCalcButtonCancel' class='btn btn-default btn-lg' data-toggle='tooltip' title='отмена'><i class='fa fa-undo'></i></button>
                    </div>
                </div>
            </td>
            <td>
                <div type="editModeView" class="col-sm-3">
                    <input type='text' modetype="calculateCatalogNumber" class="form-control input-sm" placeholder="Каталожный номер" />
                    <input type='text' modetype="calculatePriceUsd" class="form-control input-sm" placeholder="Цена за ед., $" />
                    <input type='text' modetype="calculateSumUsd" class="form-control input-sm" placeholder="Сумма вход, $" />
                    <input type='text' modetype="calculatePriceRub" class="form-control input-sm" placeholder="Цена за ед., руб." />
                    <input type='text' modetype="calculateSumRub" class="form-control input-sm" placeholder="Сумма вход, руб." />
                </div>
                <div type="readOnlyModeView" style="display: none;" class="col-sm-3">
                    <div>
                        <strong>[Каталожный номер]</strong>&nbsp;<span modetype="calculateCatalogNumberValueLabel"></span>
                    </div>
                    <div>
                        <strong>[Цена $]</strong>&nbsp;<span modetype="calculatePriceUsdValueLabel"></span>&nbsp;$ за ед.
                    </div>
                    <div>
                        <strong>[Сумма $]</strong>&nbsp;<span modetype="calculateSumUsdValueLabel"></span>&nbsp;$ всего
                    </div>
                    <div>
                        <strong>[Цена руб]</strong>&nbsp;<span modetype="calculatePriceRubValueLabel"></span>&nbsp;руб. за ед.
                    </div>
                    <div>
                        <strong>[Сумма руб]</strong>&nbsp;<span modetype="calculateSumRubValueLabel"></span>&nbsp;руб. всего
                    </div>
                </div>
                <div type="editModeView" class="col-sm-5">
                    <textarea rows="3" modetype="calculateName" class="form-control input-sm" placeholder="Наименование"></textarea>
                    <textarea rows="3" modetype="calculateReplace" class="form-control input-sm" placeholder="Замена"></textarea>
                    <input type='text' modetype="calculateProvider" class="form-control input-sm" placeholder="Поставщик" />
                </div>
                <div type="readOnlyModeView" style="display: none;" class="col-sm-5">
                    <div>
                        <strong>Наименование</strong>
                        <div modetype="calculateNameValueLabel"></div>
                    </div>
                    <div>
                        <strong>Замена</strong>
                        <div modetype="calculateReplaceValueLabel"></div>
                    </div>
                    <div>
                        <strong>Поставщик</strong>
                        <div modetype="calculateProviderValueLabel"></div>
                    </div>
                </div>
                <div type="editModeView" class="col-sm-4">
                    <select size="1" modetype="calculateProtectFact" class="form-control input-sm">
                        <option value="null">--Факт получения защиты--</option>
                        <option value="Получена нами">Получена нами</option>
                        <option value="Получена конкурентом">Получена конкурентом</option>
                        <option value="Не предоставляется">Не предоставляется</option>
                    </select>
                    <textarea rows='2' class="form-control input-sm" modetype="calculateProtectCondition" placeholder="Условия получения защиты"></textarea>
                    <textarea rows='4' class="form-control input-sm" modetype="calculateComment" placeholder="Комментарий"></textarea>
                </div>
                <div type="readOnlyModeView" style="display: none;" class="col-sm-4">
                    <div class="form-group">
                        <label>Факт получения защиты</label>
                        <div modetype="calculateProtectFactValueLabel"></div>
                        <label>[Условия получения защиты]</label>
                        <div modetype="calculateProtectConditionValueLabel"></div>
                    </div>
                    <div class="form-group">
                        <label>Комментарий</label>
                        <div modetype="calculateCommentValueLabel"></div>
                    </div>
                </div>
            </td>
            <td>
                <button type='button' modetype='saveCalcButton' class='btn btn-primary btn-lg' data-toggle='tooltip' title='сохранить'><i class='fa fa-save'></i></button><br />
                <button type='button' modetype='cancelCalcButton' class='btn btn-default btn-lg' data-toggle='tooltip' title='отмена'><i class='fa fa-undo'></i></button>
                <button type='button' modetype='deleteCalcButton' class='btn btn-link btn-lg' data-toggle='tooltip' title='удалить' style="display: none;"><i class='fa fa-trash'></i></button>
            </td>
        </tr>
    </table>
</div>
