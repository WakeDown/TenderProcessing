@using System.Web.Script.Serialization
@using System.Web.UI.WebControls
@using TenderProcessingDataAccessLayer.Models
@{
    ViewBag.Title = "Карточка заявки";
    Layout = "~/Views/Shared/_MasterPage.cshtml";
    var serializer = new JavaScriptSerializer();
    var managers = (List<Manager>)ViewBag.Managers;
    var dealTypes = (List<DealType>)ViewBag.DealTypes;
    var claimStatus = (List<ClaimStatus>)ViewBag.ClaimStatus;
    var productManagers = (List<ProductManager>)ViewBag.ProductManagers;
    var claim = (TenderClaim)ViewBag.Claim;
    var history = (List<ClaimStatusHistory>) ViewBag.StatusHistory;
}
<link href="~/Content/bootstrap-datepicker3.css" rel="stylesheet" />
<script src="~/Scripts/bootstrap-datepicker.js"></script>
<script type="text/javascript">
    var managers = @Html.Raw(serializer.Serialize(managers));
    var dealTypes = @Html.Raw(serializer.Serialize(dealTypes));
    var claimStatus = @Html.Raw(serializer.Serialize(claimStatus));
    var productManagers = @Html.Raw(serializer.Serialize(productManagers));
    var dateStart = "@ViewBag.DateStart.ToString()";
    var claim = @Html.Raw(serializer.Serialize(claim));
    var histories = @Html.Raw(serializer.Serialize(history));
    var initClaimIdNedded = false;

    $(init);

    function init() {
        messageUi.initProgressImage();
        window.addEventListener("message", messageHandler, true);
        if (claim != null && claim.ClaimStatus == 1) {
            $("#excelPanel").show();
        } else {
            $("#excelPanel").hide();
        }
        initManagersList();
        initDealTypesList();
        $("#tenderStart").datepicker({
            format: "dd.mm.yyyy",
            autoclose: true
        });
        $("#kPDeadline").datepicker({
            format: "dd.mm.yyyy",
            autoclose: true
        });
        $("#claimDeadline").datepicker({
            format: "dd.mm.yyyy",
            autoclose: true
        });
        $("#tenderStart").add("#kPDeadline").add("#claimDeadline").change(function(e) {
            var datepicker = $(e.currentTarget);
            var dt = datepicker.datepicker("getDate");
            var dateString = getDateString(dt);
            datepicker.val(dateString);
        });
        $("#butСlaimStatusCanceled").click(setClaimCancelled);
        $("#butСlaimStatusStopped").click(setClaimStopped);
        $("#tenderStart").val(dateStart);
        $("#butGetFile").click(getExcelFileFromServer);
        $("#butUploadFile").click(openFile);
        $("#butSaveClaim").click(saveClaim);
        $("#butSetClaimOnWork").click(setClaimOnWork);
        var unitList = getUnitsList(null);
        $("#unitCell").append(unitList);
        var managersList = getProductManagersList(null);
        $("#managersCell").append(managersList);
        $("#butAddPosition").click(addPositionButtonClick);
        $("[modetype='addPositionButtonOK']").click(addPosition);
        $("[modetype='addPositionButtonCancel']").click(addPositionCancel);
        if (claim != null) {
            $("#claimId").text("Заявка № " + claim.Id);
            if (claim.Positions != null) {
                var container = $("#positionTable");
                var positionsLength = claim.Positions.length;
                for (var i = 0; i < positionsLength; i++) {
                    var position = claim.Positions[i];
                    var element = getPositionElement(position);
                    container.append(element);
                }
            }
            showClaimReadOnly(claim);
            $("#butSaveClaim").hide();
            $("#butSetClaimOnWork").show();
            $("#excelPanel").show(250);
            $("#positionPanel").show(250);
            initClaimIdNedded = true;
            if (claim.ClaimStatus > 1) {
                var status = getClaimStatusById(claim.ClaimStatus);
                if (status == null) {
                    status = { Value: "Неопределен" };
                }
                $("#claimStatus").text(status.Value);
                $("#butSetClaimOnWork").hide();
                $("#addPositionRow").remove();
                $("#butAddPosition").remove();
                var cancelEditButtons = $("[modeType='editButtonCancel']", $("#positionTable"));
                $.each(cancelEditButtons, function(index, elem) {
                    $(elem).click();
                });
                var editButtons = $("[modeType='editButton']", $("#positionTable"));
                $.each(editButtons, function(index, elem) {
                    $(elem).remove();
                });
                var editPanels = $("[type='editActionPanel']", $("#positionTable"));
                $.each(editPanels, function(index, elem) {
                    $(elem).remove();
                });
                var deleteButtons = $("[modeType='deleteButton']", $("#positionTable"));
                $.each(deleteButtons, function(index, elem) {
                    $(elem).remove();
                });
                $("#excelPanel").hide();
                if (claim.ClaimStatus == 2 || claim.ClaimStatus == 3 || claim.ClaimStatus == 4 || claim.ClaimStatus == 6 || claim.ClaimStatus == 7) {
                    $("#claimStatusPanel").show();
                    if (claim.ClaimStatus == 4) {
                        $("#butСlaimStatusStopped").remove();
                    }
                }
            }
            initStatusHistory();
        }
    }

    function initStatusHistory() {
        if (histories == null) return;
        var historyLength = histories.length;
        for (var i = 0; i < historyLength; i++) {
            var statusHistory = histories[i];
            addClaimStatusHistoryElement(statusHistory);
        }
    }

    function addClaimStatusHistoryElement(model) {
        var container = $("#claimStatusHistoryContainer");
        var element = $("<li></li>");
        element.append(model.DateString + "&nbsp;");
        var status = getClaimStatusById(model.Status.Id);
        if (status == null) {
            status = { Value: "Неопределен" };
        }
        element.append(status.Value + "&nbsp;");
        element.append(model.Comment);
        container.append(element);
    }

    function setClaimCancelled(e) {
        var comment = $("#claimStatusComment").val().trim();
        var model = {
            Comment: comment,
            IdClaim: claim.Id
        }
        $.ajax({
            url: "/Claim/SetClaimCancelled",
            type: 'POST',
            dataType: 'json',
            data: JSON.stringify(model),
            processData: false,
            contentType: 'application/json; charset = utf-8 ',
            success: function(data) {
                if (data.IsComplete) {
                    claim.ClaimStatus = data.Model.Status.Id;
                    var status = getClaimStatusById(claim.ClaimStatus);
                    if (status == null) {
                        status = { Value: "Неопределен" };
                    }
                    $("#claimStatus").text(status.Value);
                    $("#claimStatusPanel").remove();
                    addClaimStatusHistoryElement(data.Model);
                } else {
                    showMessage("Ошибка");
                }
            }
        });
    }

    function setClaimStopped(e) {
        var comment = $("#claimStatusComment").val().trim();
        var model = {
            Comment: comment,
            IdClaim: claim.Id
        }
        $.ajax({
            url: "/Claim/SetClaimStopped",
            type: 'POST',
            dataType: 'json',
            data: JSON.stringify(model),
            processData: false,
            contentType: 'application/json; charset = utf-8 ',
            success: function(data) {
                if (data.IsComplete) {
                    claim.ClaimStatus = data.Model.Status.Id;
                    var status = getClaimStatusById(claim.ClaimStatus);
                    if (status == null) {
                        status = { Value: "Неопределен" };
                    }
                    $("#claimStatus").text(status.Value);
                    $("#butСlaimStatusStopped").remove();
                    $("#claimStatusComment").val("");
                    addClaimStatusHistoryElement(data.Model);
                } else {
                    showMessage("Ошибка");
                }
            }
        });
    }

    function showMessage(message) {
        messageUi.show(message);
    }

    function setClaimOnWork(e) {
        $.ajax({
            url: "/Claim/SetClaimOnWork?id=" + claim.Id,
            type: 'GET',
            contentType: 'application/json; charset = utf-8 ',
            success: function(data) {
                if (data.IsComplete) {
                    claim.ClaimStatus = data.Model.Status.Id;
                    var status = getClaimStatusById(claim.ClaimStatus);
                    if (status == null) {
                        status = { Value: "Неопределен" };
                    }
                    $("#claimStatus").text(status.Value);
                    $("#butSetClaimOnWork").hide();
                    $("#addPositionRow").remove();
                    $("#butAddPosition").remove();
                    var cancelEditButtons = $("[modeType='editButtonCancel']", $("#positionTable"));
                    $.each(cancelEditButtons, function(index, elem) {
                        $(elem).click();
                    });
                    var editButtons = $("[modeType='editButton']", $("#positionTable"));
                    $.each(editButtons, function(index, elem) {
                        $(elem).remove();
                    });
                    var editPanels = $("[type='editPositionPanel']", $("#positionTable"));
                    $.each(editPanels, function(index, elem) {
                        $(elem).remove();
                    });
                    var deleteButtons = $("[modeType='deleteButton']", $("#positionTable"));
                    $.each(deleteButtons, function(index, elem) {
                        $(elem).remove();
                    });
                    $("#excelPanel").hide();
                    addClaimStatusHistoryElement(data.Model);
                } else {
                    if (data.Message == null || data.Message.trim() == "") {
                        showMessage("Ошибка при передачи заявки в работу");
                    } else {
                        showMessage(data.Message);
                    }
                }
            }
        });
    }

    function saveClaim() {
        var validModel = isValidClaim();
        if (!validModel.isValid) {
            showMessage(validModel.message);
            return;
        }
        var tenderNumber = $("#tenderNumber").val();
        var tenderStart = $("#tenderStart").val();
        var claimDeadLine = $("#claimDeadline").val();
        var kpDeadLine = $("#kPDeadline").val();
        var customer = $("#customer").val();
        var customerInn = $("#innCustomer").val();
        var sum = Number($("#sum").val());
        var comment = $("#comment").val();
        var dealType = Number($(":selected", $("#listDealTypes")).val());
        var tenderUrl = $("#tenderUrl").val();
        var managerId = $(":selected", $("#listManagers")).val();
        var managerSubDivision = $("#managerSubDivision").text();
        var model = {
            TenderNumber: tenderNumber,
            TenderStartString: tenderStart,
            ClaimDeadlineString: claimDeadLine,
            KPDeadlineString: kpDeadLine,
            Comment: comment,
            Customer: customer,
            CustomerInn: customerInn,
            Sum: sum,
            DealType: dealType,
            TenderUrl: tenderUrl,
            Manager: { Id: managerId, SubDivision: managerSubDivision }
        };
        $.ajax({
            url: "/Claim/SaveClaim",
            type: 'POST',
            dataType: 'json',
            data: JSON.stringify(model),
            processData: false,
            contentType: 'application/json; charset = utf-8 ',
            success: saveClaimComplete
        });
    }

    function saveClaimComplete (data) {
        if (data.IsComplete) {
            claim = data.Model;
            showClaimReadOnly(claim);
            $("#claimId").text("Заявка № " + claim.Id);
            $("#butSaveClaim").hide();
            $("#butSetClaimOnWork").show();
            $("#excelPanel").show(250);
            $("#positionPanel").show(250);
            addClaimStatusHistoryElement(data.StatusHistory);
            var obj = {
                type: "setClaimId",
                error: false,
                message: claim.Id
            }
            var message = JSON.stringify(obj);
            sendMessage(message);
        } else {
            showMessage("Ошибка при сохранении заявки");
        }
    }

    function showClaimReadOnly(model) {
        var controlNames = ["#tenderNumber", "#tenderStart", "#claimDeadline", "#kPDeadline", "#customer", "#innCustomer", "#sum", "#comment", "#listDealTypes", "#tenderUrl", "#listManagers", "#managerSubDivision"];
        var controlsLength = controlNames.length;
        for (var i = 0; i < controlsLength; i++) {
            $(controlNames[i]).css("display", "none");
            $(controlNames[i] + "Label").css("display", "block");
        }
        $("#tenderNumberLabel").text(model.TenderNumber != null ? model.TenderNumber : "");
        $("#tenderStartLabel").text(model.TenderStartString);
        $("#claimDeadlineLabel").text(model.ClaimDeadlineString);
        $("#kPDeadlineLabel").text(model.KPDeadlineString);
        $("#customerLabel").text(model.Customer);
        $("#innCustomerLabel").text(model.CustomerInn);
        var sum = "";
        if (model.Sum != 0) {
            sum = model.Sum.toFixed(2);
        }
        $("#sumLabel").text(sum);
        $("#commentLabel").text(model.Comment != null ? model.Comment : "");
        var dealType = getDealTypeById(model.DealType);
        $("#listDealTypesLabel").text(dealType.Value);
        $("#tenderUrlLabel").text(model.TenderUrl != null ? model.TenderUrl : "");
        $("#listManagersLabel").text(model.Manager.Name);
        $("#managerSubDivisionLabel").text(model.Manager.SubDivision);
        var status = getClaimStatusById(model.ClaimStatus);
        if (status == null) {
            status = { Value: "Неопределен" };
        }
        $("#claimStatus").text(status.Value);
    }

    function isValidClaim() {
        var obj = { isValid: true, message: "" };
        var message = "";
        var tenderStart = $("#tenderStart").val();
        var claimDeadLine = $("#claimDeadline").val();
        var kpDeadLine = $("#kPDeadline").val();
        var customer = $("#customer").val();
        var customerInn = $("#innCustomer").val();
        var sum = $("#sum").val();
        if (tenderStart.trim() == "") {
            obj.isValid = false;
            obj.message = "Заполните поле Дата начала";
        } 
        if (claimDeadLine.trim() == "") {
            message = "Заполните поле Срок сдачи";
            if (obj.message.trim() != "") {
                message = "<br/>" + message;
            }
            obj.isValid = false;
            obj.message += message;
        }
        if (kpDeadLine.trim() == "") {
            message = "Заполните поле Срок сдачи КП";
            if (obj.message.trim() != "") {
                message = "<br/>" + message;
            }
            obj.isValid = false;
            obj.message += message;
        }
        if (customer.trim() == "") {
            message = "Заполните поле Заказчик";
            if (obj.message.trim() != "") {
                message = "<br/>" + message;
            }
            obj.isValid = false;
            obj.message += message;
        }
        if (customerInn.trim() == "") {
            message = "Заполните поле ИНН заказчика";
            if (obj.message.trim() != "") {
                message = "<br/>" + message;
            }
            obj.isValid = false;
            obj.message += message;
        }
        if (sum.trim() != "") {
            if (isNaN(Number(sum))) {
                message = "Значение в поле Сумма с НДС не является числом";
                if (obj.message.trim() != "") {
                    message = "<br/>" + message;
                }
                obj.isValid = false;
                obj.message += message;
            }
        }
        return obj;
    }

    function openFile() {
        var obj = {
            type: "mainWindow",
            error: false,
            message: "openFile"
        }
        var message = JSON.stringify(obj);
        sendMessage(message);
    }

    function sendMessage(message) {
        var target = getTargetOrigin();
        document.getElementById("uploadFile").contentWindow.postMessage(message, target);
    }

    function getTargetOrigin() {
        var url = document.location.href;
        url = url.replace("http://", "");
        var index = url.indexOf("/");
        url = url.substr(0, index);
        url = "http://" + url;
        return url;
    }

    function messageHandler(e) {
        var data = e.data;
        var obj = $.parseJSON(data);
        if (obj.type.trim() == "UploadFrameLoaded") {
            if (initClaimIdNedded) {
                var objM = {
                    type: "setClaimId",
                    error: false,
                    message: claim.Id
                }
                var message = JSON.stringify(objM);
                sendMessage(message);
            }
        }
        if (obj.type.trim() == "DownloadExcel") {
            if (obj.error == true) {
                showMessage("Ошибка при скачивании файла!");
            }
        }
        if (obj.type.trim() == "UploadExcel") {
            if (obj.error == true) {
                showMessage(obj.message);
            }
        }
        if (obj.type.trim() == "UploadExcelResult") {
            if (obj.error == true) {
                var div = $("<div style='max-width: 300px; overflow: auto'></div>");
                div.html(obj.message);
                showMessage(div);
            } else {
                var positions = obj.message;
                var container = $("#positionTable");
                if (positions != null) {
                    var positionsLength = positions.length;
                    for (var i = 0; i < positionsLength; i++) {
                        var position = positions[i];
                        var element = getPositionElement(position);
                        container.append(element);
                    }
                }
            }
        }
    }

    function getPositionElement(position) {
        var element = $("#addPositionRow").clone();
        element.attr("positionId", position.Id);
        element.removeAttr("id");
        element.show();
        var value = "";
        if (position.RowNumber != 0) {
            value = position.RowNumber;
        }
        $("[type='catalogNumberLabel']", element).text(position.CatalogNumber);
        $("[modelType='catalogNumberValue']", element).val(position.CatalogNumber);
        $("[type='nameLabel']", element).text(position.Name);
        $("[modelType='nameValue']", element).val(position.Name);
        $("[type='replaceLabel']", element).text(position.Replace);
        $("[modelType='replaceValue']", element).val(position.Replace);
        $("[type='unitLabel']", element).text(getUnitString(position.Unit));
        $("[type='unitLabel']", element).attr("val", position.Unit);
        $("option[value='" + position.Unit + "']", $("[type='unitsList']", element)).attr("selected", "selected");
        $("[type='valueLabel']", element).text(position.Value);
        $("[modelType='valueValue']", element).val(position.Value);
        $("[type='productManagerLabel']", element).text(position.ProductManager.Name);
        $("[type='productManagerLabel']", element).attr("val", position.ProductManager.Id);
        $("option[value='" + position.ProductManager.Id + "']", $("[type='productManagersList']", element)).attr("selected", "selected");
        $("[type='commentLabel']", element).text(position.Comment);
        $("[modelType='commentValue']", element).val(position.Comment);
        var price = "";
        if (position.Price != 0) price = position.Price.toFixed(2);
        $("[type='priceLabel']", element).text(price);
        $("[modelType='priceValue']", element).val(price);
        var sum = "";
        if (position.Sum != 0) sum = position.Sum.toFixed(2);
        $("[type='sumLabel']", element).text(sum);
        $("[modelType='sumValue']", element).val(sum);
        $("[modetype='addPositionButtonOK']", element).hide();
        $("[modetype='addPositionButtonCancel']", element).hide();
        $("[type='editPositionPanel']", element).show();
        $("[modetype='deleteButton']", element).show();
        var editModeButton = $("button[modeType='editButton']", element);
        editModeButton.click(editModeButtonClick);
        var editButtonCancel = $("button[modeType='editPositionButtonCancel']", element);
        editButtonCancel.click(editButtonCancelClick);
        var editButtonOk = $("button[modeType='editPositionButtonOK']", element);
        editButtonOk.click(editButtonOkClick);
        var deleteButton = $("button[modeType='deleteButton']", element);
        deleteButton.click(deleteButtonClick);
        $("[type='editModeView']", element).hide();
        $("[type='readOnlyModeView']", element).show();
        return element;
    }

    function addPositionButtonClick(e) {
        var row = $("#addPositionRow");
        $("[modeltype='rowNumberValue']", row).val("");
        $("[modeltype='catalogNumberValue']", row).val("");
        $("[modeltype='nameValue']", row).val("");
        $("[modeltype='replaceValue']", row).val("");
        $("[modeltype='valueValue']", row).val("");
        $("[modeltype='commentValuel']", row).val("");
        $("[modeltype='priceValue']", row).val("");
        $("[modeltype='sumValue']", row).val("");
        $("#addPositionRow").toggle();
    }

    function addPosition(e) {
        var row = $("#addPositionRow");
        var obj = getClaimPositionFromRow(row);
        if (obj.error) {
            showMessage(obj.message);
        } else {
            var model = obj.model;
            model.IdClaim = claim.Id;
            $.ajax({
                url: "/Claim/AddClaimPosition",
                type: 'POST',
                dataType: 'json',
                data: JSON.stringify(model),
                processData: false,
                contentType: 'application/json; charset = utf-8 ',
                success: function(data) {
                    if (data.IsComplete) {
                        $("[modeltype='rowNumberValue']", row).val("");
                        $("[modeltype='catalogNumberValue']", row).val("");
                        $("[modeltype='nameValue']", row).val("");
                        $("[modeltype='replaceValue']", row).val("");
                        $("[modeltype='valueValue']", row).val("");
                        $("[modeltype='commentValue']", row).val("");
                        $("[modeltype='priceValue']", row).val("");
                        $("[modeltype='sumValue']", row).val("");
                        $("#addPositionRow").hide();
                        var container = $("#positionTable");
                        var element = getPositionElement(data.Model);
                        container.append(element);
                    } else {
                        showMessage("Ошибка при добавлении позиции спецификации");
                    }
                }
            });
        }
    }

    function addPositionCancel(e) {
        var row = $("#addPositionRow");
        $("[modeltype='rowNumberValue']", row).val("");
        $("[modeltype='catalogNumberValue']", row).val("");
        $("[modeltype='nameValue']", row).val("");
        $("[modeltype='replaceValue']", row).val("");
        $("[modeltype='valueValue']", row).val("");
        $("[modeltype='commentValuel']", row).val("");
        $("[modeltype='priceValue']", row).val("");
        $("[modeltype='sumValue']", row).val("");
        $("#addPositionRow").hide();
    }

    function deleteButtonClick(e) {
        var button = $(e.currentTarget);
        var row = button.parent().parent();
        var id = Number(row.attr("positionId"));
        var initalBackGround = row.css("background-color");
        row.css("backgroundColor", "#EAA4A4");
        var deleted = confirm("Вы уверены что хотите удалить выделенную запись?");
        row.css("backgroundColor", initalBackGround);
        if (deleted) {
            $.ajax({
                url: "/Claim/DeleteClaimPosition?id=" + id,
                type: 'GET',
                contentType: 'application/json; charset = utf-8 ',
                success: function(data) {
                    if (data.IsComplete) {
                        row.remove();
                    } else {
                        showMessage("Запись не удалена из БД");
                    }
                }
            });
        }
    }

    function editModeButtonClick(e) {
        var button = $(e.currentTarget);
        var row = button.parent().parent().parent();
        button.hide();
        $("[type='editPositionActionPanel']", row).show();
        var controls = ["rowNumber", "catalogNumber", "name", "replace", "value", "comment", "price", "sum"];
        var controlsLength = controls.length;
        for (var i = 0; i < controlsLength; i++) {
            $("[modelType='" + controls[i] + "Value']", row).val($("[type='" + controls[i] + "Label']", row).text());
        }
        $("[type='editModeView']", row).show();
        $("[type='readOnlyModeView']", row).hide();
        selectListElement($("[type='unitsList']", row), $("[type='unitLabel']", row).attr("val"));
        selectListElement($("[type='productManagersList']", row), $("[type='productManagerLabel']", row).attr("val"));
    }

    function editButtonCancelClick(e) {
        var button = $(e.currentTarget);
        var row = button.parent().parent().parent().parent();
        button.parent().hide();
        $("[modeType='editButton']", row).show();
        $("[type='editModeView']", row).hide();
        $("[type='readOnlyModeView']", row).show();
    }

    function editButtonOkClick(e) {
        var button = $(e.currentTarget);
        var row = button.parent().parent().parent().parent();
        var obj = getClaimPositionFromRow(row);
        if (obj.error) {
            showMessage(obj.message);
        } else {
            var model = obj.model;
            model.IdClaim = claim.Id;
            model.Id = Number(row.attr("positionId"));
            $.ajax({
                url: "/Claim/EditClaimPosition",
                type: 'POST',
                dataType: 'json',
                data: JSON.stringify(model),
                processData: false,
                contentType: 'application/json; charset = utf-8 ',
                success: function(data) {
                    if (data.IsComplete) {
                        $("[type='rowNumberLabel']", row).text(model.RowNumber != 0 ? model.RowNumber : "");
                        $("[type='catalogNumberLabel']", row).text(model.CatalogNumber);
                        $("[type='nameLabel']", row).text(model.Name);
                        $("[type='replaceLabel']", row).text(model.Replace);
                        $("[type='unitLabel']", row).text(getUnitString(model.Unit));
                        $("[type='unitLabel']", row).attr("val", model.Unit);
                        $("[type='valueLabel']", row).text(model.Value);
                        $("[type='productManagerLabel']", row).text(model.ProductManager.Name);
                        $("[type='productManagerLabel']", row).attr("val", model.ProductManager.Id);
                        $("[type='commentLabel']", row).text(model.Comment);
                        $("[type='priceLabel']", row).text(model.Price != 0 ? model.Price.toFixed(2) : "");
                        $("[type='sumLabel']", row).text(model.Sum != 0 ? model.Sum.toFixed(2) : "");
                        button.parent().hide();
                        $("[modeType='editButton']", row).show();
                        $("[type='editModeView']", row).hide();
                        $("[type='readOnlyModeView']", row).show();
                    } else {
                        showMessage("Ошибка при изменении позиции спецификации");
                    }
                }
            });
        }
    }

    function getClaimPositionFromRow(row) {
        var obj = { error: false, message: "", model: null };
        var message = "";
        var name = $("[modelType='nameValue']", row).val();
        if (name.trim() == "") {
            obj.error = true;
            obj.message = "Заполните обязательное поле Наименование";
        }
        var value = $("[modelType='valueValue']", row).val();
        if (value.trim() == "") {
            message = "Заполните обязательное поле Количество";
            if (obj.message.trim() != "") {
                message = "<br/>" + message;
            }
            obj.error = true;
            obj.message += message;
        } else {
            if (isNaN(Number(value.trim())))  {
                message = "Значение '" + value.trim() + "' в поле Количество не является целым числом";
                if (obj.message.trim() != "") {
                    message = "<br/>" + message;
                }
                obj.error = true;
                obj.message += message;
            } else {
                if (value.trim().indexOf(".") != -1) {
                    message = "Значение '" + value.trim() + "' в поле Количество не является целым числом";
                    if (obj.message.trim() != "") {
                        message = "<br/>" + message;
                    }
                    obj.error = true;
                    obj.message += message;
                }
            }
        }
        var price = $("[modelType='priceValue']", row).val();
        if (price.trim() != "") {
            if (isNaN(Number(price.trim())))  {
                message = "Значение '" + price.trim() + "' в поле Цена за единицу максимум не является числом";
                if (obj.message.trim() != "") {
                    message = "<br/>" + message;
                }
                obj.error = true;
                obj.message += message;
            }
        }
        var sum = $("[modelType='sumValue']", row).val();
        if (sum.trim() != "") {
            if (isNaN(Number(sum.trim())))  {
                message = "Значение '" + sum.trim() + "' в поле Сумма максимум за единицу максимум не является числом";
                if (obj.message.trim() != "") {
                    message = "<br/>" + message;
                }
                obj.error = true;
                obj.message += message;
            }
        }
        if (!obj.error) {
            value = Number(value.trim());
            if (price.trim() != "") price = Number(price.trim());
            else price = 0;
            if (sum.trim() != "") sum = Number(sum.trim());
            else sum = 0;
            var catalogNumber = $("[modelType='catalogNumberValue']", row).val().trim();
            var replace = $("[modelType='replaceValue']", row).val().trim();
            var unit = Number($(":selected", $("[type='unitsList']", row)).val());
            var productManager = getProductManagerById($(":selected", $("[type='productManagersList']", row)).val().trim());
            var comment = $("[modelType='commentValue']", row).val().trim();
            var model = {
                CatalogNumber: catalogNumber,
                Name: name,
                Replace: replace,
                Unit: unit,
                Value: value,
                ProductManager: productManager,
                Comment: comment,
                Price: price,
                Sum: sum,
            };
            obj.model = model;
        }
        return obj;
    }

    function getUnitString(unit) {
        var result = "";
        switch (unit) {
            case 1:
                result = "Шт";
                break;
            case 2:
                result = "Упак";
                break;
        }
        return result;
    }

    function getExcelFileFromServer() {
        $("body").append("<iframe src='/Claim/GetSpecificationFile' width='0' height='0' style='display: none;' align='left'></iframe>");
    }

    function initManagersList() {
        if (managers == null || managers.length == 0) return;
        var list = $("#listManagers");
        var managersLength = managers.length;
        for (var i = 0; i < managersLength; i++) {
            var manager = managers[i];
            var option = $("<option value='" + manager.Id + "'>" + manager.Name + "</option>");
            list.append(option);
        }
        list.change(function() {
            var selElement = $(":selected", list);
            if (selElement != null) {
                var id = selElement.val();
                var selManager = getManagerById(id);
                if (selManager != null) {
                    $("#managerSubDivision").text(selManager.SubDivision);
                }
            }
        });
        list.change();
    }

    function initDealTypesList() {
        if (dealTypes == null || dealTypes.length == 0) return;
        var list = $("#listDealTypes");
        var dealTypesLength = dealTypes.length;
        for (var i = 0; i < dealTypesLength; i++) {
            var dealType = dealTypes[i];
            var option = $("<option value='" + dealType.Id + "'>" + dealType.Value + "</option>");
            list.append(option);
        }
    }

    function getManagerById(id) {
        var manager = null;
        var managersLength = managers.length;
        for (var i = 0; i < managersLength; i++) {
            var model = managers[i];
            if (model.Id.trim().toLowerCase() == id.trim().toLowerCase()) {
                manager = model;
                break;
            }
        }
        return manager;
    }

    function getProductManagerById(id) {
        var manager = null;
        var managersLength = productManagers.length;
        for (var i = 0; i < managersLength; i++) {
            var model = productManagers[i];
            if (model.Id.trim().toLowerCase() == id.trim().toLowerCase()) {
                manager = model;
                break;
            }
        }
        return manager;
    }

    function getDealTypeById(id) {
        id = Number(id);
        var dealType = null;
        var dealTypesLength = dealTypes.length;
        for (var i = 0; i < dealTypesLength; i++) {
            var model = dealTypes[i];
            if (model.Id == id) {
                dealType = model;
                break;
            }
        }
        return dealType;
    }

    function getClaimStatusById(id) {
        id = Number(id);
        var status = null;
        var statusLength = claimStatus.length;
        for (var i = 0; i < statusLength; i++) {
            var model = claimStatus[i];
            if (model.Id == id) {
                status = model;
                break;
            }
        }
        return status;
    }

    function getProductManagersList(productManagerId) {
        var list = $("<select size='1' type='productManagersList'  class='form-control input-sm'></select>");
        var productManagersLength = productManagers.length;
        for (var i = 0; i < productManagersLength; i++) {
            var model = productManagers[i];
            var option = $("<option value='" + model.Id + "'>" + model.Name + "</option>");
            if (productManagerId != null && model.Id == productManagerId) {
                option.attr("selected", "selected");
            }
            list.append(option);
        }
        return list;
    }

    function getUnitsList(unit) {
        var units = [{ Id: 1, Value: "Шт" }, { Id: 2, Value: "Упак" }];
        var list = $("<select size='1' type='unitsList' class='form-control input-sm'></select>");
        var unitsLength = units.length;
        for (var i = 0; i < unitsLength; i++) {
            var model = units[i];
            var option = $("<option value='" + model.Id + "'>" + model.Value + "</option>");
            if (unit != null && model.Id == unit) {
                option.attr("selected", "selected");
            }
            list.append(option);
        }
        return list;
    }

    function selectListElement(list, selectedValue) {
        var options = $("option", list);
        $.each(options, function(index, elem) {
            $(elem).removeAttr("selected");
            if ($(elem).val().trim() == selectedValue.trim()) {
                $(elem).attr("selected", "selected");
            }
        });
    }
</script>
<div>
    <div class="panel panel-default">
        <div class="panel-heading">
            <h4 id="claimId">
                Новая заявка
            </h4>
        </div>
        <div class="panel-body">
            <div class="form-horizontal val-form" role="form">
                <div class="form-group">
                    <label class="col-sm-2 control-label">№ конкурса</label>
                    <div class="col-sm-10">
                        <input type="text" id="tenderNumber" class="form-control"/>
                        <span id="tenderNumberLabel" style="display: none;" class="form-control"></span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label required-mark">Дата начала</label>
                    <div class="col-sm-10">
                        <input type="text" id="tenderStart" style="cursor: pointer;" class="form-control datepicker-btn"/>
                        <span id="tenderStartLabel" style="display: none;" class="form-control"></span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label required-mark">Срок сдачи</label>
                    <div class="col-sm-10">
                        <input type="text" id="claimDeadline" style="cursor: pointer;" class="form-control datepicker-btn" />
                        <span id="claimDeadlineLabel" style="display: none;" class="form-control"></span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label required-mark">Срок подачи КП</label>
                    <div class="col-sm-10">
                        <input type="text" id="kPDeadline" style="cursor: pointer;" class="form-control datepicker-btn" />
                        <span id="kPDeadlineLabel" style="display: none;" class="form-control"></span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label">Комментарий</label>
                    <div class="col-sm-10">
                        <textarea rows="7" id="comment" class="form-control"></textarea>
                        <div id="commentLabel" style="display: none;" class="form-control"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label required-mark">Заказчик</label>
                    <div class="col-sm-10">
                        <input type="text" id="customer" class="form-control"/>
                        <span id="customerLabel" style="display: none;" class="form-control"></span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label required-mark">ИНН заказчика</label>
                    <div class="col-sm-10">
                        <input type="text" id="innCustomer" class="form-control"/>
                        <span id="innCustomerLabel" style="display: none;" class="form-control"></span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label">Сумма с НДС</label>
                    <div class="col-sm-10">
                        <input type="text" id="sum" class="form-control"/>
                        <span id="sumLabel" style="display: none;" class="form-control"></span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label required-mark">Тип сделки</label>
                    <div class="col-sm-10">
                        <select size="1" id="listDealTypes" class="form-control"></select>
                        <span id="listDealTypesLabel" style="display: none;" class="form-control"></span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label">Ссылка на закупки</label>
                    <div class="col-sm-10">
                        <input type="text" id="tenderUrl" class="form-control"/>
                        <span id="tenderUrlLabel" style="display: none;" class="form-control"></span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label required-mark">Менеджер</label>
                    <div class="col-sm-10">
                        <select size="1" id="listManagers" class="form-control"></select>
                        <span id="listManagersLabel" style="display: none;" class="form-control"></span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label">Подразделение</label>
                    <div class="col-sm-10">
                        <span id="managerSubDivision"></span>
                        <span id="managerSubDivisionLabel" style="display: none;" class="form-control"></span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label">Статус заявки</label>
                    <div class="col-sm-10">
                        <span id="claimStatus"></span>
                    </div>
                </div>
                <div class="form-group">
                    <div class="col-sm-offset-2 col-sm-10">
                        <button type="button" id="butSaveClaim" class="btn btn-primary"><i class="fa fa-save"></i> сохранить</button>
                        <span id="excelPanel">
                            <button id="butGetFile" type="button" class="btn btn-default"><i class="fa fa-download"></i> скачать шаблон спецификации</button>
                            <button id="butUploadFile" type="button" class="btn btn-default" style="margin-left: 8px;"><i class="fa fa-upload"></i> загрузить спецификацию</button>
                            <iframe id="uploadFile" src="/Claim/UploadFileForm" style="display: none;"></iframe>
                        </span>
                        <button type="button" id="butSetClaimOnWork" style="display: none;" class="btn btn-success"><i class="fa fa-mail-forward"></i> в работу</button>
                        <div id="claimStatusPanel" style="display: none;">
                            <h5>Изменить статус</h5>
                            <label class="col-sm-2 control-label">Комментарий</label>
                            <div class="col-sm-10">
                                <textarea rows="7" id="claimStatusComment" class="form-control"></textarea>
                            </div>
                            <button id="butСlaimStatusCanceled" type="button" class="btn btn-default">Отменить</button>
                            <button id="butСlaimStatusStopped" type="button" class="btn btn-default">Приостановить</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="positionPanel" style="display: none; margin-left: 4px; margin-right: 4px;">
        <h5>Список позиций</h5>
        <div>
            <button type="button" id="butAddPosition" class="btn btn-default"><i class="fa fa-plus-circle"></i> добавить позицию</button>
        </div>
        <table class="table table-striped small">
            <thead>
                <tr>
                    <th colspan="9">
                        <h5>
                            <span class="label label-default">
                                Всего:
                                <span>5</span>
                            </span>
                            &nbsp;
                            <span class="label label-info">
                                из них рассчитано:
                                <span>3</span>
                            </span>
                        </h5>
                    </th>
                    <th>Продакт/Снабженец</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="positionTable">
                <tr id="addPositionRow" style="display: none;">
                    <td class="min-width text-nowrap">
                        <button type='button' modetype='addPositionButtonOK' class='btn btn-primary btn-lg' data-toggle='tooltip' title='сохранить'><i class='fa fa-save'></i></button><br />
                        <button type='button' modetype='addPositionButtonCancel' class='btn btn-default btn-lg' data-toggle='tooltip' title='отмена'><i class='fa fa-undo'></i></button>
                        <div type="editPositionPanel" style="display: none;">
                            <button type='button' modetype='editButton' class='btn btn-primary btn-lg' data-toggle='tooltip' title='изменить'><i class='fa fa-edit'></i></button>
                            <div type="editPositionActionPanel" style="display: none;">
                                <button type='button' modetype='editPositionButtonOK' class='btn btn-primary btn-lg' data-toggle='tooltip' title='изменить'><i class='fa fa-save'></i></button><br />
                                <button type='button' modetype='editPositionButtonCancel' class='btn btn-default btn-lg' data-toggle='tooltip' title='отмена'><i class='fa fa-undo'></i></button>
                            </div>
                        </div>
                    </td>
                    <td colspan="9">
                        <div type="editModeView" class="col-sm-3">
                            <input type='text' modeltype='catalogNumberValue' class="form-control input-sm" placeholder="Каталожный номер" />
                            <input type='text' modeltype='valueValue' class="form-control input-sm" placeholder="Количество" />
                            <div id="unitCell"></div>
                            <input type='text' modeltype='priceValue' class="form-control input-sm" placeholder="Цена за ед., макс." />
                            <input type='text' modeltype='sumValue' class="form-control input-sm" placeholder="Сумма, макс." />
                        </div>
                        <div type="readOnlyModeView" style="display: none;" class="col-sm-2">
                            <div>
                                <strong type='catalogNumberLabel'></strong>
                            </div>
                            <div>
                                <strong type='valueLabel'></strong>&nbsp;<span type='unitLabel'></span>
                            </div>
                            <div>
                                <strong type='priceLabel'></strong>&nbsp;руб. за ед. макс.
                            </div>
                            <div>
                                <strong type='sumLabel'></strong>&nbsp;руб. всего макс.
                            </div>
                        </div>
                        <div type="editModeView" class="col-sm-5">
                            <textarea rows="3" class="form-control input-sm" modeltype='nameValue' placeholder="Наименование"></textarea>
                            <textarea rows="3" class="form-control input-sm" modeltype='replaceValue' placeholder="Замена"></textarea>
                        </div>
                        <div type="readOnlyModeView" style="display: none;" class="col-sm-5">
                            <div>
                                <strong>Наименование</strong>
                                <div type='nameLabel'></div>
                            </div>
                            <div>
                                <strong>Замена</strong>
                                <div type='replaceLabel'></div>
                            </div>
                        </div>
                        <div type="editModeView" class="col-sm-4">
                            <strong>Продакт/Снабженец</strong><br />
                            <div id="managersCell"></div>
                            <textarea rows='4' modeltype='commentValue' class="form-control input-sm" placeholder="Комментарий"></textarea>
                        </div>
                        <div type="readOnlyModeView" style="display: none;" class="col-sm-3">
                            <div class="form-group">
                                <label>Комментарий</label>
                                <div type="commentLabel"></div>
                            </div>
                        </div>
                        <div type="readOnlyModeView" style="display: none;" class="col-sm-2">
                            <div>
                                <strong type='productManagerLabel'></strong>
                            </div>
                        </div>
                    </td>
                    <td>
                        <button type='button' modetype='addPositionButtonOK' class='btn btn-primary btn-lg' data-toggle='tooltip' title='сохранить'><i class='fa fa-save'></i></button><br />
                        <button type='button' modetype='addPositionButtonCancel' class='btn btn-default btn-lg' data-toggle='tooltip' title='отмена'><i class='fa fa-undo'></i></button>
                        <button type='button' modetype='deleteButton' class='btn btn-link btn-lg' data-toggle='tooltip' title='удалить' style="display: none;"><i class='fa fa-trash'></i></button>
                    </td>
                </tr>
            </tbody>
        </table>                
    </div>
    <div>
        <ul id="claimStatusHistoryContainer"></ul>
    </div>
</div>
